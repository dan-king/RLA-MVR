<div>
    <h1><i class="fa fa-check-circle"></i> Mark Ballot</h1>
    {{#if message}}
        <div class="alert alert-info">
            <h3><i class="fa fa-info-circle"></i> {{ message }}</h3>
        </div>
    {{/if }}
</div>
<div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title"><a data-toggle="collapse" href="#help-panel" aria-expanded="false" aria-controls="footwear"><span class="fa fa-question-circle"></span> Help</a></h3>
    </div>
    <div class="panel-body collapse" id="help-panel">
        <div class="panel panel-success">
            <div class="panel-heading">
                <h3 class="panel-title">Purpose of Page</h3>
            </div>
            <div class="panel-body">
                <ul>
                    <li>Transfer <span class="text-bold">ballot id</span> and <span class="text-bold"><em>literal</em> ballot selections</span> from selected paper ballot.</li>
                    <li>Preview ballot status: valid, overvote, invalid, etc.</li>
                    <li>Preview JSON: <span class="text-bold">as-is</span> (based on entry) and <span class="text-bold">post-processing</span> (based on any additional logic applied to ballot result)</li>
                    <li>If applicable, mark ballot as unreadable. </li>
                </ul>
            </div>
        </div>
        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">Target Audience</h3>
            </div>
            <div class="panel-body">
                <p>Department of Elections staff</p>
            </div>
        </div>
        <div class="panel panel-warning">
            <div class="panel-heading">
                <h3 class="panel-title">Frequency</h3>
            </div>
            <div class="panel-body">
                <ul>
                    <li>The page is run once per ballot.</li>
                    <li>Multiple users on different computers can simultaneously enter ballots.</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<form name="ballot-form" id="ballot-form" action="/ballots/submit-ballot/" method="POST">

<p>
    <span class="text-bold">Contest:</span> Team Mascot
</p>
<p>
    <label for="tabulator-id">Tabulator ID:</label>
    <input type="text" name="tabulator-id" id="tabulator-id" value="ABCDEFG"/>
    <label for="batch-id">Batch ID:</label>
    <input type="text" name="batch-id" id="batch-id" value="HIJKLMONP"/>
    <label for="record-id">Record ID:</label>
    <input type="text" name="record-id" id="record-id" value="QRSTUVWXYZ"/>
</p>
<div class="panel panel-success">
    <div class="panel-heading">
        <span class="text-bold">Ballot ID</span> (concatenation of Tabular ID, Batch ID and Record ID): <code>ABCDEFGHIJKLMONPQRSTUVWXYZ</code>
    </div>
    <div class="panel-body">
        <div id="ballot-container" class="container"></div>
    </div>
    <div class="panel-footer">
        <div>
            <div class="row">
                <div class="col-xs-4">
                    <button type="button" class="btn btn-success btn-lg fa fa-save" onclick="submit_ballot()"> Submit Ballot</button>
                </div>
                <div class="col-xs-4">
                    <button type="button" class="btn btn-warning btn-lg fa fa-refresh" onclick="reset_ballot()"> Reset Ballot</button>
                </div>
                <div class="col-xs-4">
                    <button type="button" class="btn btn-danger btn-lg fa fa-exclamation-triangle" onclick="alert('TO DO')"> Flag Ballot as Invalid</button>
                </div>
            </div>
        </div>
        Literal Ballot JSON:
        <br/>
        <textarea name="ballot_string" id="ballot_string" rows="5" cols="150">{"ballot-id":"ABCDEFGHIJKLMONPQRSTUVWXYZ","ballot-selections":[]}</textarea>
        <br/>
        Processed Ballot JSON:
        <br/>
        <textarea name="ballot_string_calc" id="ballot_string_calc" rows="5" cols="150">TO DO</textarea>
    </div>
</div>
</form>
<script>
function add_header_to_ballot(number_of_candidates) {
    let ballot_row = document.createElement('div')
    $(ballot_row).addClass('row')
        .appendTo($("#ballot-container"))
    let spacer = document.createElement('div')
    $(spacer).addClass('col-xs-2')
        .html("&nbsp;")
        .appendTo(ballot_row)
    for (var i = 1; i <= number_of_candidates; i++) {
        let ballot_header = document.createElement('div')
        let ordinal = get_ordinal_suffix_of_integer(i)
        $(ballot_header).addClass('col-xs-1').addClass('text-bold')
            .html(ordinal + " Choice")
            .appendTo(ballot_row)
    }
}
function add_candidate_to_ballot(number_of_candidates, candidate_number, candidate_name, candidate_identifier, candidate_image) {
    let d = document.createElement('div')
    $(d).addClass('row')
        .appendTo($("#ballot-container"))

    let candidate = document.createElement('div')
    $(candidate).addClass('col-xs-2')
        .html("<div class='xsmall_image_container'><span class=' xsmall_image_border'><img class='img-circle' src='"+candidate_image+"' width='40'></span><span class='text-bold'>"+candidate_name+"</span>&nbsp;(id:<span class='text-bold'>"+candidate_identifier+"</span>)</div>")
        .appendTo(d)
    for (var i = 1; i <= number_of_candidates; i++) {
        let ballot_checkbox = document.createElement('div')
        let ballot_id = "can"+candidate_number+"_rank" + i
        $(ballot_checkbox).addClass('col-xs-1')
            .html("<div class='checkbox-oval'><input type='checkbox' id='"+ballot_id+"' data-can_id='"+candidate_identifier+"' /><label for='"+ballot_id+"'>&nbsp;</label></div>")
            .appendTo(d)
        //$("#"+ballot_id).data("something")
    }
}
function read_ballot_form() {
    //console.log('read_ballot_form')
    var json_output = ''
    var manual_cvr = {}
    var ballot_id_json = {}
    var ballot_key = "ballot-id"
    var ballot_value = "ABCDEFGHIJKLMONPQRSTUVWXYZ"
    ballot_id_json[ ballot_key ] = ballot_value
    var b1 = {}
    var ballot_selections = []
    let n = num_candidates
    for(var i = 1; i <= n; i++) {
        for(var j = 1; j <= n; j++) {
            let varname = "can" + i + "_rank" + j
            //console.log("varname",varname)
            is_checked = $("#"+varname).is(':checked')
            //console.log(varname + "  is checked:",is_checked)
            if (is_checked){
                var bx = {}
                let candidate_id = $('#'+varname).attr('id')
                //console.log('candidate_id',candidate_id)
                let candidate_data = $('#'+candidate_id).attr('data-can_id')
                //console.log('candidate_data',candidate_data)
                bx[candidate_data] = j
                ballot_selections.push(bx)
            }
        }
    }


    manual_cvr = Object.assign({"ballot-selections": ballot_selections}, manual_cvr)
    manual_cvr = Object.assign({"ballot-id": ballot_value}, manual_cvr)

    var mcvr_json = JSON.stringify(manual_cvr)
    $('#ballot_string').text(mcvr_json)

}
function submit_ballot() {
       $("#ballot-form").submit();
}
function reset_ballot() {
    //console.log('reset_ballot')
    $('input[type=checkbox]').prop('checked',false)
    $('#ballot-form input[type=checkbox]').attr('checked',false)
    $('#ballot_string').text('{"ballot-id":"ABCDEFGHIJKLMONPQRSTUVWXYZ","ballot-selections":[]}')
}
// TODO - put in /lib/helpers.js
function get_ordinal_suffix_of_integer(i) {
    let j = i % 10,
        k = i % 100;
    if (j == 1 && k != 11) {
        return i + "st";
    }
    if (j == 2 && k != 12) {
        return i + "nd";
    }
    if (j == 3 && k != 13) {
        return i + "rd";
    }
    return i + "th";
}
var num_candidates = 8
$(function(){
    // TODO: Replace these hard-coded ballot details with content from uploaded JSON file.
    add_header_to_ballot(num_candidates)
    var candidate_num = 1
    var candidate_nam = "Ant"
    var candidate_id = "a1"
    var candidate_img = "/img/candidates/ant.png"
    add_candidate_to_ballot(num_candidates, candidate_num, candidate_nam, candidate_id, candidate_img)
    var candidate_num = 2
    var candidate_nam = "Bee"
    var candidate_id = "b2"
    var candidate_img = "/img/candidates/bee.png"
    add_candidate_to_ballot(num_candidates, candidate_num, candidate_nam, candidate_id, candidate_img)
    var candidate_num = 3
    var candidate_nam = "Cat"
    var candidate_id = "c3"
    var candidate_img = "/img/candidates/cat.png"
    add_candidate_to_ballot(num_candidates, candidate_num, candidate_nam, candidate_id, candidate_img)
    var candidate_num = 4
    var candidate_nam = "Dog"
    var candidate_id = "d4"
    var candidate_img = "/img/candidates/dog.png"
    add_candidate_to_ballot(num_candidates, candidate_num, candidate_nam, candidate_id, candidate_img)
    var candidate_num = 5
    var candidate_nam = "Elk"
    var candidate_id = "e5"
    var candidate_img = "/img/candidates/elk.png"
    add_candidate_to_ballot(num_candidates, candidate_num, candidate_nam, candidate_id, candidate_img)
    var candidate_num = 6
    var candidate_nam = "Fox"
    var candidate_id = "f6"
    var candidate_img = "/img/candidates/fox.png"
    add_candidate_to_ballot(num_candidates, candidate_num, candidate_nam, candidate_id, candidate_img)
    var candidate_num = 7
    var candidate_nam = "Gnu"
    var candidate_id = "g7"
    var candidate_img = "/img/candidates/gnu.png"
    add_candidate_to_ballot(num_candidates, candidate_num, candidate_nam, candidate_id, candidate_img)
    var candidate_num = 8
    var candidate_nam = "Hog"
    var candidate_id = "h8"
    var candidate_img = "/img/candidates/hog.png"
    add_candidate_to_ballot(num_candidates, candidate_num, candidate_nam, candidate_id, candidate_img)

    $('input:checkbox').change(function() {
        read_ballot_form()
    });
})

</script>   